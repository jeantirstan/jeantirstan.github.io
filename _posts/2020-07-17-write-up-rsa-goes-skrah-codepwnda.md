---
layout: post
title: "Codepwnda - RSA Goes Skrah Write-Up"
date: 2020-07-16 06:25:05 +0530
categories:
  - WriteUp
  - Crypto
---

Berikut WriteUp Salah Satu Challenge Pada Kategori Kriptografi Yang Ada Dalam CTF Codepwnda Yang Diadakan Oleh IPB.
<br/>

Diberikan 2 buah file, yaitu:
- `rsa-goes-skrrrahh.py` yang digunakan untuk meng-encrypt flag, dan
- `enc` adalah hasil atau output dari peng-encrypt-an flag.

**`rsa-goes-skrrrahh.py`**
```py
from gmpy2 import *
import os, struct, time

def egcd(a, b):
    if a == 0:
        return (b, 0, 1)
    g, y, x = egcd(b%a,a)
    return (g, x - (b//a) * y, y)

def modinv(a, m):
    g, x, y = egcd(a, m)
    if g != 1:
        raise Exception("No modular inverse")
    return x%m

def generateN(randomST):
    k1 = mpz_urandomb(randomST, 1024)
    k2 = mpz_urandomb(randomST, 1024)

    p = next_prime(k1)
    q = next_prime(k2)

    if is_prime(p, 50) and is_prime(q, 50):
        return [p, q]

def generateKeys(p, q):
    e = 0x10001
    n = p * q
    phi = (p-1) * (q-1)
    d = modinv(e, phi)
    h = (p+0xdeadbeef) * (q+0xdeadbeef)
    return [e, n, h]

def encryptMsg():
    seed = os.urandom(8)
    randomST = random_state(struct.unpack(">Q", seed)[0])

    p, q = generateN(randomST)
    e, n, h = generateKeys(p, q)

    flag = open("flag").read()
    flag = flag.ljust(64, "\x7e")
    flag = int(flag.encode("hex"), 16)
    encrypted = pow(flag, e, n)

    print "Cipher: {}".format(encrypted)
    print "N: {}".format(n)
    print "Hint: {}".format(h)

if __name__ == "__main__":
    encryptMsg() 
```

dan file **`enc`**.
```py
Cipher: 2783681285224397954445633434092010094202154026351075327595262315611963060834268330495003476443468455933771589021321167423952974433206799778170982398059065283311583221733327500582515864630039335118928192904883592951078506863443594128693054651308173150413944814782446460604924080949887844708703732095645295622958880669878572827156610531298376783363421384785801753032417536662122015382380889140323708534641203346350589292490826472394653845250793749628707526760481205875798918611767693363345218050757536598073662452358873149264179421540412287270509518114963322448415748603820569049446868237998366567665317608731109181957
N: 3256226148387143620748216016091767301544200222151871417285062804997515990445839897273196564112977469632288904415895789208702219044672267615643272782757966270464651099334396871080478335191111952511052661254669563908518252375444233155972983832416735017880201519006877751058589417284970582039965771233221016711318442645350110925698099770289295910882000031766951653491463807803675140995396224307604132474154433821872956743871932987528829067022435457739031806017588448296251954640125851949901704392123345256602246275586222273803279362438459210330281277165384961780739344041626232385517019828333155917126810961344433991861
Hint: 3256226148387143620748216016091767301544200222151871417285062804997515990445839897273196564112977469632288904415895789208702219044672267615643272782757966270464651099334396871080478335191111952511052661254669563908518252375444233155972983832416735017880201519006877751058589417284970582039965771233710124804125920978011223686997676454388103351196049357554477226209883509290629285087983204033202815451494581559629751828525162951060214854199388888638763294932811862670747777685064339406502372910861397837574615036661035963635147450924617475484126226676255415016995059650725575250856895523892418566200500427209543093484
```

Pada file `enc` terdapat `hint` yang dimana `hint` tersebut dikalkulasi oleh script pada line ke-31, berikut potongan script line 31.

```py
h = (p+0xdeadbeef) * (q+0xdeadbeef)
```

Dimana dari `hint` tersebut akan menjadi persamaan yang digunakan untuk mencari faktor prima `p` dan `q`. Persamaan dicari dengan cara menyederhanakan atau memindah ruas-ruas bilangan, seperti dalam matematika pada umumnya.

```py
h = (p+0xdeadbeef) * (q+0xdeadbeef)
h = pq + p*0xdeadbeef + q*0xdeadbeef + 0xdeadbeef**2
```
Karena `pq = n`, maka pq bisa kita tulis dengan `n`.
```py
h               = n + 0xdeadbeef(p+q) + 0xdeadbeef**2
h - n           = 0xdeadbeef(p+q) + 0xdeadbeef**2
0xdeadbeef(p+q) = (h - n) - 0xdeadbeef**2
```
Pindah ruas `0xdeadbeef` kiri ke ruas kanan, maka persamaan `p+q` ditemukan, yaitu sebagai berikut.
```py
p+q = ((h - n) - 0xdeadbeef**2)/0xdeadbeef
```
Sehingga, telah didapat 2 persamaan untuk mencari faktor prima `p` dan `q`. Selanjutnya dilakukan scripting menggunakan `z3 solver` untuk mendapatkan faktor prima `p` dan `q`.
```py
from z3 import *

h = 3256226148387143620748216016091767301544200222151871417285062804997515990445839897273196564112977469632288904415895789208702219044672267615643272782757966270464651099334396871080478335191111952511052661254669563908518252375444233155972983832416735017880201519006877751058589417284970582039965771233710124804125920978011223686997676454388103351196049357554477226209883509290629285087983204033202815451494581559629751828525162951060214854199388888638763294932811862670747777685064339406502372910861397837574615036661035963635147450924617475484126226676255415016995059650725575250856895523892418566200500427209543093484
n = 3256226148387143620748216016091767301544200222151871417285062804997515990445839897273196564112977469632288904415895789208702219044672267615643272782757966270464651099334396871080478335191111952511052661254669563908518252375444233155972983832416735017880201519006877751058589417284970582039965771233221016711318442645350110925698099770289295910882000031766951653491463807803675140995396224307604132474154433821872956743871932987528829067022435457739031806017588448296251954640125851949901704392123345256602246275586222273803279362438459210330281277165384961780739344041626232385517019828333155917126810961344433991861
c = 2783681285224397954445633434092010094202154026351075327595262315611963060834268330495003476443468455933771589021321167423952974433206799778170982398059065283311583221733327500582515864630039335118928192904883592951078506863443594128693054651308173150413944814782446460604924080949887844708703732095645295622958880669878572827156610531298376783363421384785801753032417536662122015382380889140323708534641203346350589292490826472394653845250793749628707526760481205875798918611767693363345218050757536598073662452358873149264179421540412287270509518114963322448415748603820569049446868237998366567665317608731109181957
e = 0x10001

s = Solver()
p, q = Int('p'), Int('q')

persamaan_1 = (p*q) == n
persamaan_2 = (p+q) == ((h - n) - 0xdeadbeef**2)/0xdeadbeef

s.add(persamaan_1)
s.add(persamaan_2)

if s.check() == sat:
    print s.model()

```
Jalankan dan didapatkan faktor prima `p` dan `q`.
```py
abdullahnz ~/Codepwnda/RSA python find_pq.py 
[q = 33385269079622478453325236063515181611256944674152365317809634437376517505269553741918964843293370582240570866273474090994802059110818210207117696390200786638375836678726128866471294378187564067762338160655251424635959985578842645031115006915051226005183322067178585233262798833434196450875360258410597163199,
 p = 97534818144528943726242400925545530269129802387851430827994976147635395054419771969458210269759609769822994313308107700342988338805456769390786716026517348178404907434666812233647447870116940654095233254690533500229037597430845760652918381249597815805059295379044297855091071068642770887503355952222308652939]

```
### Decrypting the Message
Setelah `p` dan `q` didapat, kita bisa mendekripsi `flag` secara biasa. Berikut script solver yang saya buat.
```py
from Crypto.Util.number import *
import gmpy2

h = 3256226148387143620748216016091767301544200222151871417285062804997515990445839897273196564112977469632288904415895789208702219044672267615643272782757966270464651099334396871080478335191111952511052661254669563908518252375444233155972983832416735017880201519006877751058589417284970582039965771233710124804125920978011223686997676454388103351196049357554477226209883509290629285087983204033202815451494581559629751828525162951060214854199388888638763294932811862670747777685064339406502372910861397837574615036661035963635147450924617475484126226676255415016995059650725575250856895523892418566200500427209543093484
n = 3256226148387143620748216016091767301544200222151871417285062804997515990445839897273196564112977469632288904415895789208702219044672267615643272782757966270464651099334396871080478335191111952511052661254669563908518252375444233155972983832416735017880201519006877751058589417284970582039965771233221016711318442645350110925698099770289295910882000031766951653491463807803675140995396224307604132474154433821872956743871932987528829067022435457739031806017588448296251954640125851949901704392123345256602246275586222273803279362438459210330281277165384961780739344041626232385517019828333155917126810961344433991861
c = 2783681285224397954445633434092010094202154026351075327595262315611963060834268330495003476443468455933771589021321167423952974433206799778170982398059065283311583221733327500582515864630039335118928192904883592951078506863443594128693054651308173150413944814782446460604924080949887844708703732095645295622958880669878572827156610531298376783363421384785801753032417536662122015382380889140323708534641203346350589292490826472394653845250793749628707526760481205875798918611767693363345218050757536598073662452358873149264179421540412287270509518114963322448415748603820569049446868237998366567665317608731109181957
e = 0x10001
q = 33385269079622478453325236063515181611256944674152365317809634437376517505269553741918964843293370582240570866273474090994802059110818210207117696390200786638375836678726128866471294378187564067762338160655251424635959985578842645031115006915051226005183322067178585233262798833434196450875360258410597163199
p = 97534818144528943726242400925545530269129802387851430827994976147635395054419771969458210269759609769822994313308107700342988338805456769390786716026517348178404907434666812233647447870116940654095233254690533500229037597430845760652918381249597815805059295379044297855091071068642770887503355952222308652939

phi = (p-1) * (q-1)
d = gmpy2.invert(e, phi)
m = pow(c, d, n)

print long_to_bytes(m)

```

Jalankan dan `flag` didapat.

```sh
abdullahnz ~/Codepwnda/RSA python solver.py 
codepwnda{64d6585a10d63c8ad74e9e2cf57773dee67a5d81}~~~~~~~~~~~~~
```
### Flag 
codepwnda{64d6585a10d63c8ad74e9e2cf57773dee67a5d81}
